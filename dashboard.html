<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>PFNexus Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Tailwind CSS CDN - For true production, consider a build process to purge unused CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Google Fonts - Inter -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Inter', sans-serif;
    }
  </style>
  <!-- React and ReactDOM UMD Production Builds - Loaded globally -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>

  <!-- Firebase UMD Compatibility Builds - Loaded globally -->
  <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore-compat.js"></script>

  <!-- Babel for JSX Transpilation - For true production, consider a build process instead of client-side Babel for performance. -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body class="bg-slate-900 text-white min-h-screen flex flex-col">
  <div id="root" class="flex-grow">
    <!-- Fallback/Loading message if React takes time to load -->
    <div class="flex items-center justify-center min-h-screen bg-slate-900 text-white">
      <div class="text-xl font-semibold">Loading PFNexus Dashboard...</div>
    </div>
  </div>

  <!-- Change script type to "text/babel" for JSX transpilation -->
  <script type="text/babel">
    // React, ReactDOM, and Firebase are now available globally via the UMD scripts loaded above.
    // No need for top-level 'import' statements for these libraries within this script block.
    const { useState, useEffect, createContext, useContext } = React;
    const { createRoot, createPortal } = ReactDOM; // Use createRoot for React 18, and createPortal for modals

    // Firebase modules are available globally via 'firebase' namespace
    const { initializeApp } = firebase.app;
    const { getAuth, signInAnonymously, onAuthStateChanged } = firebase.auth;
    const { getFirestore, doc, setDoc, onSnapshot } = firebase.firestore;


    // PermissionsBitField for checking Discord guild permissions
    // This is a simplified version for client-side checking.
    // Full permissions list: https://discord.com/developers/docs/topics/permissions#permissions-bitwise-flags
    class PermissionsBitField {
      constructor(bits) {
        this.bits = Number(bits); // Changed from BigInt to Number
      }

      has(permission) {
        return (this.bits & Number(permission)) === Number(permission); // Changed from BigInt to Number
      }

      static Flags = {
        ADMINISTRATOR: 1 << 3, // Changed from 1n << 3n
        MANAGE_GUILD: 1 << 5,  // Changed from 1n << 5n
        // Add other relevant permissions if needed for display/logic
        // E.g., SEND_MESSAGES: 1 << 11, VIEW_CHANNEL: 1 << 10
      };
    }

    // --- Firebase Configuration ---
    // If running in the Canvas environment, __firebase_config will be provided.
    // If running on your main website outside of Canvas, you MUST replace the placeholder
    // values below with your actual Firebase project configuration details.
    const firebaseConfig = typeof __firebase_config !== 'undefined'
      ? JSON.parse(__firebase_config)
      : {
          apiKey: "YOUR_FIREBASE_API_KEY",
          authDomain: "YOUR_FIREBASE_AUTH_DOMAIN",
          projectId: "YOUR_FIREBASE_PROJECT_ID",
          storageBucket: "YOUR_FIREBASE_STORAGE_BUCKET",
          messagingSenderId: "YOUR_FIREBASE_MESSAGING_SENDER_ID",
          appId: "YOUR_FIREBASE_APP_ID",
          // measurementId: "YOUR_FIREBASE_MEASUREMENT_ID" // Optional
        };
    console.log("Firebase Config Loaded:", firebaseConfig);

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // --- Context for User Data and Firebase Auth State ---
    const AuthContext = createContext(null);

    const AuthProvider = ({ children }) => {
      const [user, setUser] = useState(null); // Discord user data
      const [firebaseUser, setFirebaseUser] = useState(null); // Firebase user data
      const [discordAccessToken, setDiscordAccessToken] = useState(null);
      const [loading, setLoading] = useState(true);
      const [authReady, setAuthReady] = useState(false); // Indicates Firebase auth is ready

      useEffect(() => {
        console.log("AuthProvider useEffect: Initializing auth state listener.");
        // Read Discord token and user from localStorage immediately
        const storedToken = localStorage.getItem('discordAccessToken');
        const storedUser = localStorage.getItem('discordUser');

        if (storedToken) {
          setDiscordAccessToken(storedToken);
          console.log("AuthProvider: Found Discord Access Token in localStorage.");
        } else {
          console.log("AuthProvider: No Discord Access Token found in localStorage.");
        }
        if (storedUser) {
          try {
            const parsedUser = JSON.parse(storedUser);
            setUser(parsedUser);
            console.log("AuthProvider: Found Discord User in localStorage:", parsedUser.username);
          } catch (e) {
            console.error("AuthProvider: Error parsing stored Discord user:", e);
            localStorage.removeItem('discordUser');
          }
        } else {
          console.log("AuthProvider: No Discord User found in localStorage.");
        }

        // Firebase Auth State Listener
        const unsubscribe = onAuthStateChanged(auth, async (currentUser) => {
          setFirebaseUser(currentUser);
          setAuthReady(true); // Firebase auth is initialized and state is known
          setLoading(false); // Initial loading complete
          console.log("AuthProvider: Firebase Auth State Changed. Current Firebase User:", currentUser ? currentUser.uid : "None");
          console.log("AuthProvider: authReady set to true, loading set to false.");
        });

        // Cleanup subscription
        return () => unsubscribe();
      }, []);

      // If no Firebase user is logged in, sign in anonymously to allow Firestore access
      useEffect(() => {
        console.log(`AuthProvider useEffect (anonymous sign-in check): authReady=${authReady}, firebaseUser=${firebaseUser ? firebaseUser.uid : 'null'}, loading=${loading}`);
        if (authReady && !firebaseUser && !loading) {
          console.log("AuthProvider useEffect: Attempting anonymous Firebase sign-in.");
          signInAnonymously(auth).then(() => {
            console.log("AuthProvider: Signed in anonymously to Firebase.");
          }).catch(error => {
            console.error("AuthProvider: Error signing in anonymously to Firebase:", error);
            // Handle anonymous sign-in failure, maybe show an error to the user
          });
        }
      }, [authReady, firebaseUser, loading]);

      // Function to handle logout
      const logout = () => {
        console.log("Logging out...");
        localStorage.removeItem("discordUser");
        localStorage.removeItem("discordAccessToken");
        // Sign out from Firebase if authenticated, then redirect
        if (firebaseUser) {
          auth.signOut().then(() => {
            console.log("Firebase user signed out. Redirecting to index.html.");
            window.location.href = 'index.html'; // Redirect to login page
          }).catch(error => {
            console.error("Error signing out from Firebase:", error);
            window.location.href = 'index.html'; // Still redirect even if Firebase signOut fails
          });
        } else {
          console.log("No Firebase user to sign out. Redirecting to index.html.");
          window.location.href = 'index.html'; // Just redirect if no Firebase user
        }
      };

      return (
        <AuthContext.Provider value={{ user, firebaseUser, discordAccessToken, loading, authReady, logout }}>
          {children}
        </AuthContext.Provider>
      );
    };

    // --- Modal Component ---
    const Modal = ({ children, onClose, title }) => {
      // Use createPortal to render the modal outside the main React DOM tree,
      // typically directly under document.body, while still being managed by React.
      return createPortal(
        <div className="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 p-4">
          <div className="bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-lg w-full p-6 relative">
            <h3 className="text-2xl font-bold mb-4 text-gray-900 dark:text-white">{title}</h3>
            <button
              onClick={onClose}
              className="absolute top-4 right-4 text-gray-500 hover:text-gray-700 dark:hover:text-gray-300"
            >
              <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
            {children}
          </div>
        </div>,
        document.body // This is the DOM node where the modal content will be rendered
      );
    };

    // --- Main Dashboard Component ---
    const App = () => {
      const { user, firebaseUser, discordAccessToken, loading, authReady, logout } = useContext(AuthContext);
      const [guilds, setGuilds] = useState([]);
      const [selectedGuild, setSelectedGuild] = useState(null);
      const [guildConfig, setGuildConfig] = useState(null);
      const [configLoading, setConfigLoading] = useState(false);
      const [error, setError] = useState(null);
      const [showErrorModal, setShowErrorModal] = useState(false);
      const [modalMessage, setModalMessage] = useState('');

      // States for form fields, mirroring the /setup command
      const [welcomeMessage, setWelcomeMessage] = useState('');
      const [welcomeChannelId, setWelcomeChannelId] = useState('');
      const [enableWelcome, setEnableWelcome] = useState(false);
      const [logChannelId, setLogChannelId] = useState('');
      const [modRoleId, setModRoleId] = useState('');
      const [ticketPingRoleId, setTicketPingRoleId] = useState('');
      const [managementRoleId, setManagementRoleId] = useState('');
      const [gameIssueRoleId, setGameIssueRoleId] = useState('');
      const [modmailCategoryId, setModmailCategoryId] = useState('');
      const [rolesMustLog, setRolesMustLog] = useState(''); // Comma-separated string of IDs
      const [rolesNoLog, setRolesNoLog] = useState('');     // Comma-separated string of IDs

      // Reset form states when a new guild is selected or config is cleared
      const resetFormStates = () => {
        setWelcomeMessage('');
        setWelcomeChannelId('');
        setEnableWelcome(false);
        setLogChannelId('');
        setModRoleId('');
        setTicketPingRoleId('');
        setManagementRoleId('');
        setGameIssueRoleId('');
        setModmailCategoryId('');
        setRolesMustLog('');
        setRolesNoLog('');
      };

      // Populate form states from fetched config data
      const populateFormStates = (config) => {
        setWelcomeMessage(config.welcomeMessage || '');
        setWelcomeChannelId(config.welcomeChannelId || '');
        setEnableWelcome(config.enableWelcome || false);
        setLogChannelId(config.logChannelId || '');
        setModRoleId(config.modRoleId || '');
        setTicketPingRoleId(config.ticketPingRoleId || '');
        setManagementRoleId(config.managementRoleId || '');
        setGameIssueRoleId(config.gameIssueRoleId || '');
        setModmailCategoryId(config.modmailCategoryId || '');
        setRolesMustLog(Array.isArray(config.rolesMustLogIds) ? config.rolesMustLogIds.join(',') : '');
        setRolesNoLog(Array.isArray(config.rolesNoLogIds) ? config.rolesNoLogIds.join(',') : '');
      };

      // Effect to fetch user's guilds from Discord API
      useEffect(() => {
        console.log("App useEffect: Fetching user guilds. User:", user ? user.username : "None", "AccessToken:", discordAccessToken ? "Present" : "Missing", "AuthReady:", authReady);
        const fetchUserGuilds = async () => {
          // Ensure Discord user and access token are available and auth is ready
          if (user && discordAccessToken && authReady) {
            setError(null);
            try {
              const response = await fetch('https://discord.com/api/users/@me/guilds', {
                headers: {
                  Authorization: `Bearer ${discordAccessToken}`,
                },
              });

              if (!response.ok) {
                const errorData = await response.json();
                // If token is invalid/expired, force logout
                if (response.status === 401) {
                    setModalMessage("Your Discord session has expired. Please log in again.");
                    setShowErrorModal(true);
                    logout();
                    return;
                }
                throw new Error(`Failed to fetch guilds: ${response.status} - ${errorData.message}`);
              }

              const userGuilds = await response.json();

              // Filter guilds: User must have ADMINISTRATOR or MANAGE_GUILD permissions
              // The bot must also be in the guild. We assume if the user has admin perms,
              // they can invite the bot, and the bot is already in the server.
              // A more robust check would involve a backend call to verify bot presence.
              const filteredGuilds = userGuilds.filter(guild => {
                const userPermissions = new PermissionsBitField(guild.permissions);
                const isAdmin = userPermissions.has(PermissionsBitField.Flags.ADMINISTRATOR) || userPermissions.has(PermissionsBitField.Flags.MANAGE_GUILD);
                // For simplicity, we're assuming the bot is in all guilds the user is admin of.
                // In a real scenario, you'd need to verify the bot's presence in each guild.
                // This usually involves:
                // 1. Having a list of guilds the bot is actually in (e.g., fetched from your bot's database).
                // 2. Cross-referencing the user's guilds with the bot's guilds.
                // For this example, we'll rely solely on user permissions.
                return isAdmin;
              });

              setGuilds(filteredGuilds);
              console.log("App useEffect: Successfully fetched and filtered guilds.");

            } catch (err) {
              console.error("App useEffect: Error fetching guilds:", err);
              setError(`Error fetching servers: ${err.message}. Please ensure the bot is in the server and you have Administrator or Manage Server permissions.`);
              setModalMessage(`Error fetching servers: ${err.message}. Please ensure the bot is in the server and you have Administrator or Manage Server permissions.`);
              setShowErrorModal(true);
            }
          } else {
            console.log("App useEffect: Skipping guild fetch. User, AccessToken, or AuthReady not yet available.");
            setGuilds([]);
          }
        };

        if (!loading && authReady) {
          fetchUserGuilds();
        }
      }, [user, discordAccessToken, loading, authReady, logout]);

      // Effect to fetch guild config from Firestore when a guild is selected
      useEffect(() => {
        console.log(`App useEffect (Firestore config): firebaseUser=${firebaseUser ? firebaseUser.uid : 'null'}, authReady=${authReady}, selectedGuild=${selectedGuild ? selectedGuild.name : 'null'}`);
        if (!firebaseUser || !authReady) {
          console.log("App useEffect (Firestore config): Firebase user not ready or auth not ready. Skipping.");
          return; // Ensure Firebase auth is ready
        }

        if (selectedGuild) {
          setConfigLoading(true);
          setError(null);
          resetFormStates(); // Clear form when new guild selected

          const guildDocRef = doc(db, 'serverConfigs', selectedGuild.id);

          // Use onSnapshot for real-time updates to the config
          const unsubscribe = onSnapshot(guildDocRef, async (docSnap) => {
            if (docSnap.exists()) {
              const configData = docSnap.data();
              setGuildConfig(configData);
              populateFormStates(configData);
              console.log("App useEffect (Firestore onSnapshot): Fetched guild config:", configData);
            } else {
              // If no config exists, create a default one
              console.log("App useEffect (Firestore onSnapshot): No config found for this guild, creating default.");
              const defaultConfig = {
                welcomeMessage: `Welcome to ${selectedGuild.name}, {user}!`,
                welcomeChannelId: '',
                enableWelcome: false,
                logChannelId: '',
                modRoleId: '',
                ticketPingRoleId: '',
                managementRoleId: '',
                gameIssueRoleId: '',
                modmailCategoryId: '',
                rolesMustLogIds: [],
                rolesNoLogIds: [],
              };
              try {
                await setDoc(guildDocRef, defaultConfig);
                setGuildConfig(defaultConfig);
                populateFormStates(defaultConfig);
                console.log("Default config created.");
              } catch (err) {
                console.error("App useEffect (Firestore onSnapshot): Error creating default config:", err);
                setError(`Error creating default config: ${err.message}`);
                setModalMessage(`Error creating default config: ${err.message}`);
                setShowErrorModal(true);
              }
            }
            setConfigLoading(false);
          }, (err) => {
            console.error("App useEffect (Firestore onSnapshot): Error listening to guild config:", err);
            setError(`Error fetching guild config: ${err.message}`);
            setModalMessage(`Error fetching guild config: ${err.message}`);
            setShowErrorModal(true);
            setConfigLoading(false);
          });

          return () => unsubscribe(); // Cleanup Firestore listener
        } else {
          console.log("App useEffect (Firestore config): No guild selected. Clearing config.");
          setGuildConfig(null);
          resetFormStates();
        }
      }, [selectedGuild, firebaseUser, authReady]); // Re-run when selectedGuild or Firebase user changes

      const handleSaveConfig = async (e) => {
        e.preventDefault();
        if (!selectedGuild) {
          setModalMessage('No server selected to save configuration.');
          setShowErrorModal(true);
          return;
        }
        if (!firebaseUser) {
            setModalMessage('You must be logged in to save configurations. Please refresh the page or try again.');
            setShowErrorModal(true);
            return;
        }

        setConfigLoading(true);
        setError(null);

        // Construct the updated config object
        const updatedConfig = {
          welcomeMessage: welcomeMessage,
          welcomeChannelId: welcomeChannelId,
          enableWelcome: enableWelcome,
          logChannelId: logChannelId,
          modRoleId: modRoleId,
          ticketPingRoleId: ticketPingRoleId,
          managementRoleId: managementRoleId,
          gameIssueRoleId: gameIssueRoleId,
          modmailCategoryId: modmailCategoryId,
          // Convert comma-separated strings to arrays of IDs
          rolesMustLogIds: rolesMustLog.split(',').map(id => id.trim()).filter(id => id !== ''),
          rolesNoLogIds: rolesNoLog.split(',').map(id => id.trim()).filter(id => id !== ''),
        };

        try {
          // Use setDoc with { merge: true } to update only specified fields
          await setDoc(doc(db, 'serverConfigs', selectedGuild.id), updatedConfig, { merge: true });
          setModalMessage('Configuration saved successfully!');
          setShowErrorModal(true); // Reusing error modal for success message
          console.log("Configuration saved successfully for guild:", selectedGuild.name);
        } catch (err) {
          console.error("Error saving config:", err);
          setError(`Error saving configuration: ${err.message}`);
          setModalMessage(`Error saving configuration: ${err.message}`);
          setShowErrorModal(true);
        } finally {
          setConfigLoading(false);
        }
      };

      // Handle initial loading states
      console.log(`Dashboard Render: loading=${loading}, authReady=${authReady}, user=${user ? user.username : 'null'}, discordAccessToken=${discordAccessToken ? 'present' : 'null'}`);
      if (loading || !authReady) {
        return (
          <div className="flex items-center justify-center min-h-screen bg-slate-900 text-white">
            <div className="text-xl font-semibold">Loading Dashboard...</div>
          </div>
        );
      }

      // If Discord user or token is missing after initial load, redirect to index.html
      // This handles cases where localStorage might have been cleared or token expired.
      if (!user || !discordAccessToken) {
        console.log("Dashboard Render: User or Discord Access Token missing after load. Redirecting to index.html.");
        // Use a small delay to allow React to finish its render cycle before redirecting
        setTimeout(() => {
          window.location.href = 'index.html';
        }, 100);
        return null; // Don't render anything while redirecting
      }

      return (
        <div className="min-h-screen bg-slate-900 text-white font-inter flex flex-col">
          <div className="container mx-auto p-6 flex-grow">
            <header className="flex flex-col md:flex-row justify-between items-center py-4 border-b border-slate-700 mb-8">
              <h1 className="text-4xl font-extrabold text-sky-500 mb-4 md:mb-0">PFNexus Dashboard</h1>
              <div className="flex items-center space-x-4">
                <img src={user.avatar ? `https://cdn.discordapp.com/avatars/${user.id}/${user.avatar}.png?size=64` : `https://placehold.co/64x64/000080/FFFFFF?text=${user.username ? user.username[0] : 'U'}`} alt="User Avatar" className="w-12 h-12 rounded-full border-2 border-sky-500" />
                <span className="text-lg font-medium text-slate-200">{user.username}#${user.discriminator || '0000'}</span>
                <button
                  onClick={logout}
                  className="px-4 py-2 bg-red-600 hover:bg-red-700 text-white font-semibold rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105"
                >
                  Sign Out
                </button>
              </div>
            </header>

            <main className="grid grid-cols-1 md:grid-cols-3 gap-8">
              {/* Server Selection Panel */}
              <div className="md:col-span-1 bg-slate-800 p-6 rounded-xl shadow-lg border border-slate-700">
                <h2 className="text-2xl font-bold mb-4 text-slate-100">Your Managed Servers</h2>
                {guilds.length === 0 ? (
                  <p className="text-slate-400">Loading servers or no servers found where you have Administrator or Manage Server permissions.</p>
                ) : (
                  <ul className="space-y-2">
                    {guilds.map((guild) => (
                      <li key={guild.id}>
                        <button
                          onClick={() => setSelectedGuild(guild)}
                          className={`w-full text-left p-3 rounded-lg transition duration-200 ease-in-out flex items-center space-x-3
                            ${selectedGuild?.id === guild.id
                              ? 'bg-sky-700 text-white font-semibold shadow-md'
                              : 'bg-slate-700 hover:bg-slate-600 text-slate-200'
                            }`}
                        >
                          {guild.icon ? (
                            <img src={`https://cdn.discordapp.com/icons/${guild.id}/${guild.icon}.png?size=64`} alt={`${guild.name} icon`} className="w-8 h-8 rounded-full" />
                          ) : (
                            <div className="w-8 h-8 rounded-full bg-slate-600 flex items-center justify-center text-sm font-bold text-slate-300">
                              {guild.name[0]}
                            </div>
                          )}
                          <span>{guild.name}</span>
                        </button>
                      </li>
                    ))}
                  </ul>
                )}
              </div>

              {/* Configuration Panel */}
              <div className="md:col-span-2 bg-slate-800 p-8 rounded-xl shadow-lg border border-slate-700">
                <h2 className="text-2xl font-bold mb-6 text-slate-100">
                  {selectedGuild ? `Configure: ${selectedGuild.name}` : 'Select a Server to Configure'}
                </h2>

                {selectedGuild && (
                  configLoading ? (
                    <div className="text-center py-10">
                      <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-sky-500 mx-auto"></div>
                      <p className="mt-4 text-lg text-slate-400">Loading Configuration...</p>
                    </div>
                  ) : (
                    <form onSubmit={handleSaveConfig} className="space-y-6">
                      {/* Welcome Message Section */}
                      <div className="p-4 bg-slate-700 rounded-lg shadow-inner">
                        <h3 className="text-xl font-semibold mb-3 text-slate-100">Welcome Messages</h3>
                        <label htmlFor="enableWelcome" className="flex items-center space-x-2 mb-4 cursor-pointer">
                          <input
                            type="checkbox"
                            id="enableWelcome"
                            checked={enableWelcome}
                            onChange={(e) => setEnableWelcome(e.target.checked)}
                            className="form-checkbox h-5 w-5 text-sky-500 rounded focus:ring-sky-500 bg-slate-900 border-slate-600"
                          />
                          <span className="text-slate-300">Enable Welcome Messages</span>
                        </label>

                        <div className="mb-4">
                          <label htmlFor="welcomeChannelId" className="block text-sm font-medium text-slate-300 mb-1">
                            Welcome Channel ID
                          </label>
                          <input
                            type="text"
                            id="welcomeChannelId"
                            value={welcomeChannelId}
                            onChange={(e) => setWelcomeChannelId(e.target.value)}
                            placeholder="Enter Channel ID (e.g., 123456789012345678)"
                            className="mt-1 block w-full px-3 py-2 border border-slate-600 rounded-md shadow-sm focus:ring-sky-500 focus:border-sky-500 bg-slate-900 text-white"
                          />
                          <p className="mt-1 text-xs text-slate-400">The ID of the text channel where new member welcome messages will be sent.</p>
                        </div>

                        <div>
                          <label htmlFor="welcomeMessage" className="block text-sm font-medium text-slate-300 mb-1">
                            Welcome Message Content
                          </label>
                          <textarea
                            id="welcomeMessage"
                            rows="4"
                            value={welcomeMessage}
                            onChange={(e) => setWelcomeMessage(e.target.value)}
                            placeholder="Welcome to {guild}, {user}! Enjoy your stay."
                            className="mt-1 block w-full border border-slate-600 rounded-md shadow-sm p-2 focus:ring-sky-500 focus:border-sky-500 bg-slate-900 text-white"
                          ></textarea>
                          <p className="mt-1 text-xs text-slate-400">
                            Use `{`{user}`}` for the new member's mention and `{`{guild}`}` for the server name.
                          </p>
                        </div>
                      </div>

                      {/* Logging & Moderation Section (from /setup) */}
                      <div className="p-4 bg-slate-700 rounded-lg shadow-inner">
                        <h3 className="text-xl font-semibold mb-3 text-slate-100">Logging & Moderation</h3>
                        <div className="mb-4">
                          <label htmlFor="logChannelId" className="block text-sm font-medium text-slate-300 mb-1">
                            Log Channel ID
                          </label>
                          <input
                            type="text"
                            id="logChannelId"
                            value={logChannelId}
                            onChange={(e) => setLogChannelId(e.target.value)}
                            placeholder="Enter Channel ID"
                            className="mt-1 block w-full px-3 py-2 border border-slate-600 rounded-md shadow-sm focus:ring-sky-500 focus:border-sky-500 bg-slate-900 text-white"
                          />
                          <p className="mt-1 text-xs text-slate-400">Channel for moderation actions and ticket logs.</p>
                        </div>

                        <div className="mb-4">
                          <label htmlFor="modRoleId" className="block text-sm font-medium text-slate-300 mb-1">
                            Moderator Role ID
                          </label>
                          <input
                            type="text"
                            id="modRoleId"
                            value={modRoleId}
                            onChange={(e) => setModRoleId(e.target.value)}
                            placeholder="Enter Role ID"
                            className="mt-1 block w-full px-3 py-2 border border-slate-600 rounded-md shadow-sm focus:ring-sky-500 focus:border-sky-500 bg-slate-900 text-white"
                          />
                          <p className="mt-1 text-xs text-slate-400">Role for additional moderator permissions.</p>
                        </div>

                        <div className="mb-4">
                          <label htmlFor="modmailCategoryId" className="block text-sm font-medium text-slate-300 mb-1">
                            Modmail Category ID
                          </label>
                          <input
                            type="text"
                            id="modmailCategoryId"
                            value={modmailCategoryId}
                            onChange={(e) => setModmailCategoryId(e.target.value)}
                            placeholder="Enter Category ID"
                            className="mt-1 block w-full px-3 py-2 border border-slate-600 rounded-md shadow-sm focus:ring-sky-500 focus:border-sky-500 bg-slate-900 text-white"
                          />
                          <p className="mt-1 text-xs text-slate-400">Category for new ticket channels created by the bot.</p>
                        </div>
                      </div>

                      {/* Ticket Ping Roles Section (from /setup) */}
                      <div className="p-4 bg-slate-700 rounded-lg shadow-inner">
                        <h3 className="text-xl font-semibold mb-3 text-slate-100">Ticket Ping Roles</h3>
                        <div className="mb-4">
                          <label htmlFor="ticketPingRoleId" className="block text-sm font-medium text-slate-300 mb-1">
                            General Ticket Ping Role ID
                          </label>
                          <input
                            type="text"
                            id="ticketPingRoleId"
                            value={ticketPingRoleId}
                            onChange={(e) => setTicketPingRoleId(e.target.value)}
                            placeholder="Enter Role ID"
                            className="mt-1 block w-full px-3 py-2 border border-slate-600 rounded-md shadow-sm focus:ring-sky-500 focus:border-sky-500 bg-slate-900 text-white"
                          />
                          <p className="mt-1 text-xs text-slate-400">Role to ping for 'Other/General Support' tickets.</p>
                        </div>

                        <div className="mb-4">
                          <label htmlFor="managementRoleId" className="block text-sm font-medium text-slate-300 mb-1">
                            Management Ticket Ping Role ID
                          </label>
                          <input
                            type="text"
                            id="managementRoleId"
                            value={managementRoleId}
                            onChange={(e) => setManagementRoleId(e.target.value)}
                            placeholder="Enter Role ID"
                            className="mt-1 block w-full px-3 py-2 border border-slate-600 rounded-md shadow-sm focus:ring-sky-500 focus:border-sky-500 bg-slate-900 text-white"
                          />
                          <p className="mt-1 text-xs text-slate-400">Role to ping for 'Serious Issues' and 'Perk Claim' tickets.</p>
                        </div>

                        <div className="mb-4">
                          <label htmlFor="gameIssueRoleId" className="block text-sm font-medium text-slate-300 mb-1">
                            Ingame Issues Ticket Ping Role ID
                          </label>
                          <input
                            type="text"
                            id="gameIssueRoleId"
                            value={gameIssueRoleId}
                            onChange={(e) => setGameIssueRoleId(e.target.value)}
                            placeholder="Enter Role ID"
                            className="mt-1 block w-full px-3 py-2 border border-slate-600 rounded-md shadow-sm focus:ring-sky-500 focus:border-sky-500 bg-slate-900 text-white"
                          />
                          <p className="mt-1 text-xs text-slate-400">Role to ping for 'Ingame Issues' tickets.</p>
                        </div>
                      </div>

                      {/* Flight Log Roles Section (from /setup) */}
                      <div className="p-4 bg-slate-700 rounded-lg shadow-inner">
                        <h3 className="text-xl font-semibold mb-3 text-slate-100">Flight Log Roles</h3>
                        <div className="mb-4">
                          <label htmlFor="rolesMustLog" className="block text-sm font-medium text-slate-300 mb-1">
                            Roles That MUST Log Flights (IDs, comma-separated)
                          </label>
                          <input
                            type="text"
                            id="rolesMustLog"
                            value={rolesMustLog}
                            onChange={(e) => setRolesMustLog(e.target.value)}
                            placeholder="RoleID1,RoleID2"
                            className="mt-1 block w-full border border-slate-600 rounded-md shadow-sm p-2 focus:ring-sky-500 focus:border-sky-500 bg-slate-900 text-white"
                          />
                          <p className="mt-1 text-xs text-slate-400">
                            Comma-separated list of Role IDs. Members with these roles MUST log flights. Leave empty to apply to all non-excluded members.
                          </p>
                        </div>

                        <div className="mb-4">
                          <label htmlFor="rolesNoLog" className="block text-sm font-medium text-slate-300 mb-1">
                            Roles That DO NOT Need to Log Flights (IDs, comma-separated)
                          </label>
                          <input
                            type="text"
                            id="rolesNoLog"
                            value={rolesNoLog}
                            onChange={(e) => setRolesNoLog(e.target.value)}
                            placeholder="RoleID1,RoleID2"
                            className="mt-1 block w-full border border-slate-600 rounded-md shadow-sm p-2 focus:ring-sky-500 focus:border-sky-500 bg-slate-900 text-white"
                          />
                          <p className="mt-1 text-xs text-slate-400">
                            Comma-separated list of Role IDs. Members with these roles DO NOT need to log flights.
                          </p>
                        </div>
                      </div>

                      <button
                        type="submit"
                        className="w-full px-6 py-3 bg-green-600 hover:bg-green-700 text-white font-bold rounded-lg shadow-lg transition duration-300 ease-in-out transform hover:scale-105"
                        disabled={configLoading}
                      >
                        {configLoading ? 'Saving...' : 'Save Configuration'}
                      </button>
                    </form>
                  )
                )}
              </div>
            </main>
          </div>

          {showErrorModal && (
            <Modal title="Notification" onClose={() => setShowErrorModal(false)}>
              <p className="text-slate-300 text-center">{modalMessage}</p>
              <button
                onClick={() => setShowErrorModal(false)}
                className="mt-6 w-full px-4 py-2 bg-sky-600 hover:bg-sky-700 text-white font-semibold rounded-lg shadow-md transition duration-300 ease-in-out"
              >
                Close
              </button>
            </Modal>
          )}

          <footer class="mt-8 py-4 text-center text-slate-500 text-sm">
            &copy; 2025 PFNexus. All rights reserved.
          </footer>
        </div>
      );
    };

    // Render the App wrapped with AuthProvider
    createRoot(document.getElementById('root')).render(
      <React.StrictMode>
        <AuthProvider>
          <App />
        </AuthProvider>
      </React.StrictMode>
    );
  </script>
</body>
</html>
